name: DevOps CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y redis-server
    
    - name: Start Redis
      run: |
        sudo systemctl start redis
        redis-cli ping
    
    - name: Install Python dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest requests
    
    - name: Run unit tests
      run: |
        python test_app.py
      
  security-sast:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Bandit SAST
      run: |
        pip install bandit
        bandit -r . -f json -o bandit-report.json -c .bandit.yml || echo "Bandit completed with findings"
        bandit -r . -f html -o bandit-report.html -c .bandit.yml || true
    
    - name: Upload SAST reports
      uses: actions/upload-artifact@v4
      with:
        name: sast-reports
        path: |
          bandit-report.json
          bandit-report.html
          
  security-dast:
    runs-on: ubuntu-latest
    needs: test
    steps:
    - uses: actions/checkout@v4
    
    - name: Build test image
      run: |
        docker build -t translation-api-test .
    
    - name: Start API for DAST
      run: |
        docker run -d -p 5001:5001 --name api-test translation-api-test
        sleep 20
        echo "🚀 API started for security testing"
        
        # Test API is responding
        curl -f http://localhost:5001/health || exit 1
    
    - name: Run simple security tests
      run: |
        echo "=== Running basic security tests ==="
        
        # Test 1: Headers security
        echo "Testing security headers..."
        curl -I http://localhost:5001/ | grep -i "server\|x-content-type-options\|x-frame-options"
        
        # Test 2: Check for common vulnerabilities
        echo "Testing for common endpoints..."
        for endpoint in /admin /phpmyadmin /wp-admin /console /actuator; do
          status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5001$endpoint)
          if [ "$status" != "404" ]; then
            echo "⚠️  Found accessible endpoint: $endpoint (status: $status)"
          fi
        done
        
        # Test 3: Test SQL injection (basic)
        echo "Testing basic injection..."
        curl -X POST http://localhost:5001/translate \
          -H "Content-Type: application/json" \
          -d '{"text":"'\'' OR 1=1--", "target_lang":"fr"}' \
          -s | grep -i "error\|exception" || echo "✅ No obvious SQL injection vulnerability"
        
        echo "✅ Basic security tests completed"
    
    - name: Stop test container
      run: |
        docker stop api-test || true
        docker rm api-test || true

  observability-capture:
    runs-on: ubuntu-latest
    needs: test
    steps:
    - uses: actions/checkout@v4
    
    - name: Start API for observability tests
      run: |
        docker build -t translation-api-obs .
        docker run -d -p 5001:5001 --name obs-test translation-api-obs
        sleep 15
        
        # Wait for API to be ready
        until curl -s http://localhost:5001/health > /dev/null; do
          sleep 5
        done
    
    - name: Capture metrics and logs
      run: |
        # Capture initial metrics
        curl -s http://localhost:5001/metrics/prometheus > prometheus-initial.txt
        curl -s http://localhost:5001/metrics/detailed > detailed-metrics.json
        curl -s http://localhost:5001/health > health-check.json
        
        # Generate traffic for meaningful metrics
        echo "📊 Generating test traffic..."
        for i in {1..10}; do
          curl -X POST http://localhost:5001/translate \
            -H "Content-Type: application/json" \
            -d "{\"text\":\"hello world ${i}\", \"target_lang\":\"fr\"}" \
            -s -o /dev/null -w "Request ${i}: %{http_code}\n"
        done
        
        # Capture metrics after traffic
        curl -s http://localhost:5001/metrics/prometheus > prometheus-after.txt
        
        # Capture Docker logs
        docker logs obs-test > app-logs.txt
        
        echo "✅ Observability data captured"
    
    - name: Upload observability evidence
      uses: actions/upload-artifact@v4
      with:
        name: observability-proof
        path: |
          prometheus-initial.txt
          prometheus-after.txt
          detailed-metrics.json
          health-check.json
          app-logs.txt

  build-and-push:
    runs-on: ubuntu-latest
    needs: [test, security-sast, security-dast]
    # CORRIGÉ : Exécuter sur main ET develop
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Docker image
      run: |
        docker build -t translation-api:${{ github.sha }} .
        docker tag translation-api:${{ github.sha }} translation-api:latest
    
    - name: Test Docker image
      run: |
        docker run -d --name test-api -p 5001:5001 translation-api:latest
        sleep 15
        
        # Test the containerized API
        curl -f http://localhost:5001/health || (docker logs test-api && exit 1)
        curl -f http://localhost:5001/metrics/prometheus || exit 1
        
        docker stop test-api
        docker rm test-api

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Push to Docker Hub
      run: |
        docker tag translation-api:${{ github.sha }} ${{ secrets.DOCKERHUB_USERNAME }}/translation-api:latest
        docker tag translation-api:${{ github.sha }} ${{ secrets.DOCKERHUB_USERNAME }}/translation-api:${{ github.sha }}
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/translation-api:latest
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/translation-api:${{ github.sha }}
        echo "✅ Image pushed to Docker Hub: ${{ secrets.DOCKERHUB_USERNAME }}/translation-api:latest"

  kubernetes-deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    # CORRIGÉ : Exécuter seulement sur main (pas sur develop)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Kubernetes (Kind)
      run: |
        # Installer Kind
        curl -Lo ./kind https://kind.sigs.k8s.io/dl/latest/kind-linux-amd64
        chmod +x ./kind
        sudo mv ./kind /usr/local/bin/kind
        
        # Installer kubectl
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/kubectl
    
    - name: Create Kind cluster
      run: |
        kind create cluster --name devops-cluster
        kubectl cluster-info --context kind-devops-cluster
        echo "🔄 Waiting for cluster to be ready..."
        sleep 30
    
    - name: Deploy to Kubernetes
      run: |
        # Replace image in deployment manifest
        sed -i "s|IMAGE_PLACEHOLDER|${{ secrets.DOCKERHUB_USERNAME }}/translation-api:latest|g" k8s/deployment.yaml
        
        # Apply Kubernetes manifests
        kubectl apply -f k8s/
        echo "📦 Applied Kubernetes manifests"
        
        # Wait for deployment to be ready
        echo "⏳ Waiting for deployment to be ready..."
        kubectl wait --for=condition=available --timeout=300s deployment/translation-api
        echo "✅ Deployment is ready"
    
    - name: Verify deployment
      run: |
        # Check resources
        echo "=== Kubernetes Resources ==="
        kubectl get all
        echo ""
        
        echo "=== Pods ==="
        kubectl get pods -o wide
        echo ""
        
        echo "=== Services ==="
        kubectl get services
        echo ""
        
        echo "=== Pod Logs ==="
        kubectl logs deployment/translation-api --tail=20
        
        # Get service URL for Kind
        echo "=== Service URL ==="
        kubectl get service translation-service -o jsonpath='{.spec.clusterIP}:{.spec.ports[0].port}' > service-url.txt
        echo "Service: $(cat service-url.txt)"
    
    - name: Capture deployment evidence
      run: |
        # Capture cluster state
        kubectl get all -o wide > k8s-cluster-state.txt
        kubectl describe deployment translation-api > k8s-deployment-describe.txt
        kubectl logs deployment/translation-api > k8s-pod-logs.txt
        kubectl describe service translation-service > k8s-service-describe.txt
        
        echo "📸 Kubernetes deployment evidence captured"
    
    - name: Upload Kubernetes evidence
      uses: actions/upload-artifact@v4
      with:
        name: kubernetes-deployment
        path: |
          k8s-cluster-state.txt
          k8s-deployment-describe.txt
          k8s-pod-logs.txt
          k8s-service-describe.txt
          service-url.txt
    
    - name: Clean up Kind cluster
      if: always()
      run: |
        kind delete cluster --name devops-cluster || true

  final-report:
    runs-on: ubuntu-latest
    needs: 
      - kubernetes-deploy
      - observability-capture
    # CORRIGÉ : Toujours exécuter le rapport final
    if: always()
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Generate final report
      run: |
        echo "# DevOps Project Final Report" > final-report.md
        echo "## Pipeline Execution Summary" >> final-report.md
        echo "**Build Date:** $(date)" >> final-report.md
        echo "**Commit:** ${{ github.sha }}" >> final-report.md
        echo "**Branch:** ${{ github.ref }}" >> final-report.md
        echo "## Job Status" >> final-report.md
        
        # Vérifier quels jobs ont été exécutés
        if [ "${{ needs.kubernetes-deploy.result }}" != "skipped" ]; then
          echo "- ✅ Kubernetes Deploy: ${{ needs.kubernetes-deploy.result }}" >> final-report.md
        else
          echo "- ⏭️ Kubernetes Deploy: SKIPPED (not on main branch)" >> final-report.md
        fi
        
        if [ "${{ needs.observability-capture.result }}" != "skipped" ]; then
          echo "- ✅ Observability Capture: ${{ needs.observability-capture.result }}" >> final-report.md
        else
          echo "- ⏭️ Observability Capture: SKIPPED" >> final-report.md
        fi
        
        echo "## Artifacts Generated" >> final-report.md
        echo "- Security reports (SAST/DAST)" >> final-report.md
        echo "- Observability metrics and logs" >> final-report.md
        
        if [ "${{ needs.kubernetes-deploy.result }}" != "skipped" ]; then
          echo "- Kubernetes deployment evidence" >> final-report.md
          echo "- Docker image: ${{ secrets.DOCKERHUB_USERNAME }}/translation-api:latest" >> final-report.md
        else
          echo "- ⏭️ Kubernetes deployment: Not deployed (main branch only)" >> final-report.md
        fi
    
    - name: Upload final report
      uses: actions/upload-artifact@v4
      with:
        name: final-documentation
        path: final-report.md