name: DevOps CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest requests
    
    - name: Run unit tests
      run: |
        python -c "from src import app; print('✅ App imports successfully')"
        python -c "
        import requests
        import subprocess
        import time
        
        # Start the app in background
        process = subprocess.Popen(['python', 'src/app.py'])
        time.sleep(10)
        
        try:
            # Test health endpoint
            response = requests.get('http://localhost:5001/health', timeout=5)
            print(f'Health check status: {response.status_code}')
            print(f'Health response: {response.json()}')
            
            # Test translation endpoint
            response = requests.post('http://localhost:5001/translate', 
                                   json={'text': 'hello', 'target_lang': 'fr'},
                                   timeout=5)
            print(f'Translation status: {response.status_code}')
            print(f'Translation response: {response.json()}')
            
        finally:
            process.terminate()
            process.wait()
        "
    
    - name: Run structured tests
      run: |
        python test_app.py

  security-sast:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Bandit SAST
      run: |
        pip install bandit
        bandit -r . -f json -o bandit-report.json -c .bandit.yml || echo "Bandit completed with findings"
        bandit -r . -f html -o bandit-report.html -c .bandit.yml || true
    
    - name: Upload SAST reports
      uses: actions/upload-artifact@v4
      with:
        name: sast-reports
        path: |
          bandit-report.json
          bandit-report.html

  security-dast:
    runs-on: ubuntu-latest
    needs: test
    steps:
    - uses: actions/checkout@v4
    
    - name: Build test image
      run: |
        docker build -t translation-api-test .
    
    - name: Start API for DAST
      run: |
        docker run -d -p 5001:5001 --name api-test translation-api-test
        sleep 20
        echo "🚀 API started for security testing"
        
        # Test API is responding
        curl -f http://localhost:5001/health || exit 1
    
    - name: Run OWASP ZAP baseline scan
      uses: zaproxy/action-baseline@v0.9.0
      with:
        target: 'http://localhost:5001'
        rules_file_name: '.zap/rules.tsv'
        cmd_options: '-a -j'
        token: ${{ github.token }}
    
    - name: Upload DAST report
      uses: actions/upload-artifact@v3
      with:
        name: dast-reports
        path: |
          zap-report.html
          zap-report.json
    
    - name: Stop test container
      run: |
        docker stop api-test || true
        docker rm api-test || true

  observability-capture:
    runs-on: ubuntu-latest
    needs: test
    steps:
    - uses: actions/checkout@v4
    
    - name: Start API for observability tests
      run: |
        docker build -t translation-api-obs .
        docker run -d -p 5001:5001 --name obs-test translation-api-obs
        sleep 15
        
        # Wait for API to be ready
        until curl -s http://localhost:5001/health > /dev/null; do
          sleep 5
        done
    
    - name: Capture metrics and logs
      run: |
        # Capture initial metrics
        curl -s http://localhost:5001/metrics/prometheus > prometheus-initial.txt
        curl -s http://localhost:5001/metrics/detailed > detailed-metrics.json
        curl -s http://localhost:5001/health > health-check.json
        
        # Generate traffic for meaningful metrics
        echo "📊 Generating test traffic..."
        for i in {1..10}; do
          curl -X POST http://localhost:5001/translate \
            -H "Content-Type: application/json" \
            -d "{\"text\":\"hello world ${i}\", \"target_lang\":\"fr\"}" \
            -s -o /dev/null -w "Request ${i}: %{http_code}\n"
        done
        
        # Capture metrics after traffic
        curl -s http://localhost:5001/metrics/prometheus > prometheus-after.txt
        
        # Capture Docker logs
        docker logs obs-test > app-logs.txt
        
        echo "✅ Observability data captured"
    
    - name: Upload observability evidence
      uses: actions/upload-artifact@v3
      with:
        name: observability-proof
        path: |
          prometheus-initial.txt
          prometheus-after.txt
          detailed-metrics.json
          health-check.json
          app-logs.txt

  build-and-push:
    runs-on: ubuntu-latest
    needs: [test, security-sast, security-dast]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Docker image
      run: |
        docker build -t translation-api:${{ github.sha }} .
        docker tag translation-api:${{ github.sha }} translation-api:latest
    
    - name: Test Docker image
      run: |
        docker run -d --name test-api -p 5001:5001 translation-api:latest
        sleep 15
        
        # Test the containerized API
        curl -f http://localhost:5001/health || (docker logs test-api && exit 1)
        curl -f http://localhost:5001/metrics/prometheus || exit 1
        
        docker stop test-api
        docker rm test-api

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Push to Docker Hub
      run: |
        docker tag translation-api:${{ github.sha }} ${{ secrets.DOCKERHUB_USERNAME }}/translation-api:latest
        docker tag translation-api:${{ github.sha }} ${{ secrets.DOCKERHUB_USERNAME }}/translation-api:${{ github.sha }}
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/translation-api:latest
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/translation-api:${{ github.sha }}
        echo "✅ Image pushed to Docker Hub: ${{ secrets.DOCKERHUB_USERNAME }}/translation-api:latest"

  kubernetes-deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up minikube
      uses: medyagh/setup-minikube@v1
      with:
        version: latest
        driver: docker
    
    - name: Start minikube cluster
      run: |
        minikube start --driver=docker --memory=4096 --cpus=2
        minikube status
        echo "🔄 Waiting for cluster to be ready..."
        sleep 30
    
    - name: Deploy to Kubernetes
      run: |
        # Replace image in deployment manifest
        sed -i "s|IMAGE_PLACEHOLDER|${{ secrets.DOCKERHUB_USERNAME }}/translation-api:latest|g" k8s/deployment.yaml
        
        # Apply Kubernetes manifests
        kubectl apply -f k8s/
        echo "📦 Applied Kubernetes manifests"
        
        # Wait for deployment to be ready
        kubectl wait --for=condition=available --timeout=300s deployment/translation-api
        echo "✅ Deployment is ready"
    
    - name: Verify deployment
      run: |
        # Check resources
        kubectl get all
        kubectl get pods -o wide
        kubectl get services
        
        # Check logs
        kubectl logs deployment/translation-api --tail=20
        
        # Test service (if possible)
        minikube service translation-service --url > service-url.txt || echo "Service URL captured"
        
        echo "🔍 Deployment verification completed"
    
    - name: Capture deployment evidence
      run: |
        # Capture cluster state
        kubectl get all -o wide > k8s-cluster-state.txt
        kubectl describe deployment translation-api > k8s-deployment-describe.txt
        kubectl logs deployment/translation-api > k8s-pod-logs.txt
        
        # Capture service details
        kubectl describe service translation-service > k8s-service-describe.txt
        
        echo "📸 Kubernetes deployment evidence captured"
    
    - name: Upload Kubernetes evidence
      uses: actions/upload-artifact@v3
      with:
        name: kubernetes-deployment
        path: |
          k8s-cluster-state.txt
          k8s-deployment-describe.txt
          k8s-pod-logs.txt
          k8s-service-describe.txt
          service-url.txt

  final-report:
    runs-on: ubuntu-latest
    needs: [kubernetes-deploy, observability-capture]
    if: always()
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Generate final report
      run: |
        echo "# DevOps Project Final Report" > final-report.md
        echo "## Pipeline Execution Summary" >> final-report.md
        echo "**Build Date:** $(date)" >> final-report.md
        echo "**Commit:** ${{ github.sha }}" >> final-report.md
        echo "## Job Status" >> final-report.md
        echo "- ✅ Tests: ${{ needs.test.result }}" >> final-report.md
        echo "- ✅ SAST Security: ${{ needs.security-sast.result }}" >> final-report.md
        echo "- ✅ DAST Security: ${{ needs.security-dast.result }}" >> final-report.md
        echo "- ✅ Docker Build: ${{ needs.build-and-push.result }}" >> final-report.md
        echo "- ✅ Kubernetes Deploy: ${{ needs.kubernetes-deploy.result }}" >> final-report.md
        echo "## Artifacts Generated" >> final-report.md
        echo "- Security reports (SAST/DAST)" >> final-report.md
        echo "- Observability metrics and logs" >> final-report.md
        echo "- Kubernetes deployment evidence" >> final-report.md
        echo "- Docker image: ${{ secrets.DOCKERHUB_USERNAME }}/translation-api:latest" >> final-report.md
    
    - name: Upload final report
      uses: actions/upload-artifact@v3
      with:
        name: final-documentation
        path: final-report.md
